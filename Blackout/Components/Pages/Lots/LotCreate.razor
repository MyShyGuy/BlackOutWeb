@page "/lots/create"

@inject IBLService bLService;
@inject NavigationManager NavMan;


<h3>Create new Lot</h3>
@if(products == null)
{
    <p><em>Loading...</em></p>
}
else
{
<div class="row">
    <div class="col-md-4">
            <EditForm Model="newLot" OnValidSubmit="CreateLot" >
                <DataAnnotationsValidator/>
                <ValidationSummary/>

                    <div class="mb-3">
                        <label class="form-label">Product</label>
                        <InputSelect class="form-control" Value="newLot.ProductID" ValueChanged="@((int value) => UpdateProductAndUnit(value))" ValueExpression="@(() => newLot.ProductID)">
                            <option value="0">Select Product</option>
                            @foreach(var prod in products)
                            {
                                <option value="@prod.ProductID">@prod.Title</option>
                            }
                            </InputSelect>
                        <ValidationMessage For="@(() => newLot.ProductID)" />          
                    </div>
                    <div class="mb-3">
                        <label for="form-label">Expiry Date</label>
                        <InputDate class="form-control" @bind-Value="newLot.ExpiryDate" />
                        <ValidationMessage For="@(() => newLot.ExpiryDate)" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Location</label>
                        <InputText class="form-control" @bind-Value="newLot.Location" />
                        <ValidationMessage For="@(() => newLot.Location)" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Amount</label>
                        <InputNumber class="form-control" @bind-Value="newLot.Amount" />
                        <ValidationMessage For="@(() => newLot.Amount)" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Size</label>
                        <div class="input-group">
                            <InputNumber class="form-control" @bind-Value="newLot.Size" TValue="decimal" />
                            @if (!string.IsNullOrEmpty(selectedUnit))
                            {
                                <span class="input-group-text">@selectedUnit</span>
                            }
                        </div>
                        <ValidationMessage For="@(() => newLot.Size)" />
                    </div>
                    <button type="submit" class="btn btn-primary">Submit</button>
            </EditForm>
    </div>
</div>
}

@code
{
    public List<Product> products {get; set;} = new List<Product>();

    [SupplyParameterFromForm]
    public LotDTO newLot {get; set;} = new LotDTO(){
        ProductID = 0,
        Amount = 0,
        Location = string.Empty,
        EntryDate = DateTime.Now,
        ExpiryDate = DateTime.Now.AddDays(1)
    };

    private string selectedUnit = string.Empty;

    private async Task UpdateProductAndUnit(int productId)
    {
        newLot.ProductID = productId;

        if (productId > 0)
        {
            var selectedProduct = products.FirstOrDefault(p => p.ProductID == productId);
            selectedUnit = selectedProduct?.Unit?.UnitID ?? string.Empty;
        }
        else
        {
            selectedUnit = string.Empty;
        }
        
        StateHasChanged();
    }

    private async Task CreateLot(EditContext args)
    {
        var id = await bLService.AddLotAsync(newLot);
        NavMan.NavigateTo($"/lots/{id}");
    }

    protected async override Task OnInitializedAsync()
    {
        products = (await bLService.GetAllProductsAsync()).ToList();
    }
}