@page "/delete/{UnitId}"

@inject IBLService blService
@inject NavigationManager NavMan

<h3>Delete Unit</h3>

@if (unit == null)
{
    <p>Loading...</p>
}
else
{
    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger">@errorMessage</div>
    }
    <p>Are you sure you want to delete unit with ID: @unit.UnitID?</p>
    <button class="btn btn-danger" @onclick="DeleteUnit" disabled="@(referencingProducts != null && referencingProducts.Count > 0)">Delete</button>
    <button class="btn btn-secondary" @onclick="@(() => NavMan.NavigateTo("/units"))">Cancel</button>
}

@code
{
    [Parameter]
    public string? UnitId { get; set; }

    private Unit? unit;
    private List<Product>? referencingProducts;
    private string? errorMessage;

    protected override async Task OnParametersSetAsync()
    {
        if (UnitId != null)
        {
            unit = await blService.GetUnitByIdAsync(UnitId);
            // find products that reference this unit
            var allProducts = await blService.GetAllProductsAsync();
            referencingProducts = allProducts.Where(p => p.UnitID == UnitId).ToList();
            if (referencingProducts != null && referencingProducts.Count > 0)
            {
                errorMessage = $"Cannot delete unit because {referencingProducts.Count} product(s) reference it. Delete or reassign those products first.";
            }
        }
    }

    private async Task DeleteUnit()
    {
        if (unit != null)
        {
            if (referencingProducts == null || referencingProducts.Count == 0)
            {
                await blService.DeleteUnitAsync(unit.UnitID);
                NavMan.NavigateTo("/units");
            }
            else
            {
                errorMessage = "Cannot delete unit because there are products using it. Please remove those products first.";
            }
        }
    }
}